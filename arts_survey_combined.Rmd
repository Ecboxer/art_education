---
author: "Eric Boxer"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      cache = TRUE,
                      warning = FALSE,
                      message = FALSE)
```

## NYC Schools Arts Survey Data
The [2017-2018 Arts Survey Data](https://data.cityofnewyork.us/Education/2017-2018-Arts-Survey-Data/475h-cg5t) has data about arts teachers, budgets, partnerships with cultural organizations and parental involvement in NYC public schools.  

In an effort to gain greater context for this data, we can examine it in conjuction with publicly available [ELA and Math state test results](https://infohub.nyced.org/reports-and-policies/citywide-information-and-data/test-results) and [demographic data](https://data.cityofnewyork.us/Education/2013-2018-Demographic-Snapshot-School/s52a-8aq6).  

My goals were to understand the state of arts programs in NYC schools, what variables affect the resources of arts programs, and whether arts programs have an effect on the academic performance of students.  

```{r load data}
library(dagitty)
library(ggplot2)
library(ggpubr)
library(ggridges)
library(MatchIt)
library(tidyverse)
library(RColorBrewer)
library(MASS)
library(aod)
df <- read_csv('resources/arts_demo_ela_math.csv')
theme_eric <- function(base_size = 11,
                      base_family = 'URWHelvetica',
                      base_line_size = base_size / 170,
                      base_rect_size = base_size / 170){
  theme_bw(base_size = base_size, 
                base_family = base_family,
                base_line_size = base_line_size) %+replace%
    theme(
      plot.title = element_text(
        color = rgb(25, 43, 65, maxColorValue = 255), 
        face = "bold",
        hjust = 0),
      axis.title = element_text(
        color = rgb(105, 105, 105, maxColorValue = 255),
        size = rel(0.75)),
      axis.text = element_text(
        color = rgb(105, 105, 105, maxColorValue = 255),
        size = rel(0.5)),
      panel.grid.major = element_line(
        rgb(105, 105, 105, maxColorValue = 255),
        linetype = "dotted"),   
      panel.grid.minor = element_line(
        rgb(105, 105, 105, maxColorValue = 255),
        linetype = "dotted", 
        size = rel(4)),
      
      complete = TRUE
    )
}
theme_set(theme_eric())
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
c1 <- '#000044'
c4 <- c('#222222', '#555555', '#888888', '#BBBBBB')
c5 <- c('#222222', '#444444', '#666666', '#888888', '#AAAAAA')
```

```{r q names}
q_arts <- df %>% colnames() %>% .[grepl("^Q", .)]
q_ela <- df %>% colnames() %>% .[grepl("ela$", .)]
q_math <- df %>% colnames() %>% .[grepl("math$", .)]
q_demo <- df %>% colnames() %>% setdiff(union(q_arts, union(q_ela, q_math)))
disc_4 <- c("Dance", "Music", "Theater", "Visual Arts")
disc_5 <- c("Dance", "Film", "Music", "Theater", "Visual Arts")
```

```{r get perc_34, results = 'hide'}
#Get performance metrics of interest, % of passing students
perc_34_ela <- q_ela %>% .[grepl("^perc_34", .)]
perc_34_math <- q_math %>% .[grepl("^perc_34", .)]

#Get percent passing for all grades in 2018.
perc_34_all_2018 <- union(perc_34_ela, perc_34_math) %>%
  .[grepl("All Grades_2018", .)]
df %>% dplyr::select(perc_34_all_2018) %>% is.na() %>% colSums()
#Missing data for 370 schools
#Get percent passing for 4th graders in 2018
perc_34_4_2018 <- union(perc_34_ela, perc_34_math) %>% 
  .[grepl("4_2018", .)]
df %>% dplyr::select(perc_34_4_2018) %>% is.na() %>% colSums()

#Rename columns
temp <- c('perc_34_all_2018_ela', 'perc_34_all_2018_math')
colnames(df)[colnames(df) %in% perc_34_all_2018] <- temp
perc_34_all_2018 <- temp
```

```{r q3 missing, results = 'hide'}
#Q3 arts supervisor
q3 <- q_arts %>% .[grepl("^Q3_", .)]
df %>% dplyr::select(q3) %>% sapply(function(x) sum(is.na(x)))
```

```{r q2 no designated supervisor, results = 'hide'}
df$Q2_1 %>% sum()
df$Q2_1 %>% mean()
```

### Arts Education Liaison
In 2018, 1265 schools were surveyed. Schools were asked whether they have a designated arts supervisor. 5.6%, 72 schools, had no arts supervisor. My first question has to do with whether there is any relation between the presence of an arts supervisor and the demographics of the student population.

```{r supervisor and demos}
df$Q2_factor <- df$Q2_1 %>% as.factor()
g1 <- df %>% dplyr::select(Q2_factor, total_enrollment_2017) %>% 
  ggplot(aes(x = total_enrollment_2017,
             color = Q2_factor,
             stat(density))) +
  geom_freqpoly(alpha = .5, size = 1) +
  scale_color_manual(values = c4[c(1,3)],
                    labels = c('No', 'Yes'),
                    name = 'Arts Supervisor?') +
  ylab('') + xlab('Total Enrollment')
g2 <- df %>% dplyr::select(Q2_factor, perc_pov_2017) %>% 
  ggplot(aes(x = perc_pov_2017,
             color = Q2_factor,
             stat(density))) +
  geom_freqpoly(alpha = .5, size = 1) +
  scale_color_manual(values = c4[c(1,3)],
                    labels = c('No', 'Yes'),
                    name = 'Arts Supervisor?') +
  ylab('') + xlab('Student Poverty (%)')
g3 <- df %>% dplyr::select(Q2_factor, perc_female_2017) %>% 
  ggplot(aes(x = perc_female_2017,
             color = Q2_factor,
             stat(density))) +
  geom_freqpoly(alpha = .5, size = 1) +
  scale_color_manual(values = c4[c(1,3)],
                    labels = c('No', 'Yes'),
                    name = 'Arts Supervisor?') +
  ylab('') + xlab('Female Students (%)')
g4 <- df %>% dplyr::select(Q2_factor, perc_black_2017) %>% 
  ggplot(aes(x = perc_black_2017,
             color = Q2_factor,
             stat(density))) +
  geom_freqpoly(alpha = .5, size = 1) +
  scale_color_manual(values = c4[c(1,3)],
                    labels = c('No', 'Yes'),
                    name = 'Arts Supervisor?') +
  ylab('') + xlab('Black Students (%)')
figure <- ggarrange(g1, g2, g3, g4,
                    labels = c('1', '2', '3', '4'),
                    ncol = 2,
                    nrow = 2)
figure
```

Schools without a designated arts supervisor appear to have more black students than those with supervisors (Fig 4). There appear to be several schools withan arts supervisor and very high poverty, but there is no clear relation (Fig 2). I also do not see a significant relation between total enrollment (Fig 1) or student gender ratio (Fig 3) and having an arts supervisor. Most schools have about 500 students and gender splits close to 50-50 so a small difference would be hard to detect in these graphs.  

In order to assess the significance of the differences pointed we see above, we can try to fit a logistic regression to the relationship between each variable and the binary response "Does the school have an an arts supervisor?"

```{r supervisor and demos stats, results = 'hide'}
demos <- c('total_enrollment_2017', 'perc_pov_2017', 'perc_female_2017', 'perc_black_2017')
rel_risk = list()
for (i in demos) {
  temp <- df %>% dplyr::select(Q2_1, i) %>% 
    glm(Q2_1~., data=., family='binomial')
  print(i)
  print(temp %>% summary())
  print(temp %>% confint.default())
  
  c.int <- temp$coefficients[1]
  c.i <- temp$coefficients[2]
  control <- exp(c.int) / (1 + exp(c.int))
  rel_risk[i] <- exp(c.i) / (1 - control + (control * exp(c.i)))
}
```

These regressions lend support to the differences spotted in the plots of student poverty and race, but the most statistically significant coefficient comes from total enrollment. The coefficient for total enrollment is negative with a p-value below a significance level of 0.001. Percentages of impoverished and black students have positive coefficients with p-values below a significance level of 0.01. As we had assumed from the graphs, there was no significant relation between gender and whether a school had an arts supervisor.  
In order to better interpret these results I converted the standard R logistic regression coefficients into relative risk, [as seen here](https://www.bmj.com/content/348/bmj.f7450.full?ijkey=NHT1YVsoX1RCm8r&keytype=ref).

```{r supervisor rel risk}
rel_risk[c(1, 2, 4)]
```

An increase in total enrollment of one student is associated with a .25% decrease in the likelihood that a school has an arts supervisor. An increase of one percentage point in student poverty and in share of black students is associated with 2.13% and 1.26% increases, respectively, in the likelihood that a school has an arts supervisor.

```{r supervisor and demos all, results='hide'}
df %>% dplyr::select(Q2_1, demos) %>% dplyr::select(-perc_female_2017) %>% 
  glm(Q2_1~., data=., family='binomial') %>% 
  summary()
df %>% dplyr::select(demos) %>% dplyr::select(-perc_female_2017) %>% 
  lm(total_enrollment_2017~., data=.) %>% 
  summary()
```

Consider the possibility that there is confounding between these variables, ie. small schools tend to serve poor, mostly black student populations. To address this possibility I ran a logistic regression upon total enrollment, student poverty and share of black students. This yielded only one significant feature, total enrollment, supporting some sort of statistical interdependence between the variables.  
Let S denote school art supervisor, E enrollment, P poverty and B black students.

```{r cg supervisor}
g <- dagitty('dag {
    S [pos="0,1"]
    E [pos="1,2"]
    P [pos="2,1"]
    B [pos="1,0"]
    
    E -> S
    P -> S
    B -> S
    P -> E
    B -> E
    B <-> P
}')
plot(g)
```

To further investigate confounding, I ran a linear model for total enrollment on percentage of impoverished and black students. As suspected, both had negative relationships with total enrollment. In particular, with a p-value less than significance level 0.001, each additional percentage point of black students was associated with a decrease of 5.22 students.  

As a former NYC public school student this coincides with my experience of the school system. In my old neighborhood of Canarsie in Brooklyn was a school previously known as South Shore High School. It served thousands of poor, majority minority students. In 2010, the school was converted into the [South Shore Educational Complex](https://insideschools.org/school/18K515) and now houses five smaller high schools. A naive observer could be expected to assume that small schools have higher faculty:student ratios and more resources to expend on their students. In reality the policies of the NYC DOE have led to the exact opposite, with underperforming schools split up without necessarily being given the resources to turn around their performance.  

My second question is whether there is any relation between having an arts supervisor and student academic performance.  
```{r supervisor performance}
df %>%
  dplyr::select(perc_34_all_2018_ela, Q2_1) %>% 
  lm(perc_34_all_2018_ela~., data=.) %>%
  summary()
df %>%
  dplyr::select(perc_34_all_2018_ela, Q2_1, perc_pov_2017, perc_black_2017, total_enrollment_2017) %>% 
  lm(perc_34_all_2018_ela~., data=.) %>%
  summary()
df %>%
  dplyr::select(perc_34_all_2018_math, Q2_1) %>% 
  lm(perc_34_all_2018_math~., data=.) %>%
  summary()
df %>%
  dplyr::select(perc_34_all_2018_math, Q2_1, perc_pov_2017, perc_black_2017, total_enrollment_2017) %>% 
  lm(perc_34_all_2018_math~., data=.) %>%
  summary()
```

To measure academic performance, we can use the percentage of students to receive a 3 or 4 on state standardized tests (grades corresponding to at or above expectations), denoted `perc_34`. If we consider the relationship between having an arts supervisor and academic performance, then we see an 11 and 14 point decrease in English Language Arts (ELA) and math, respectively, at a significance level less than 0.001.  
However, considering the causal relationship above, we can introduce context by conditioning on student poverty, share of black students, and total enrollment. In this case we do not have any statistically significant relation with ELA scores and a four point decrease in math scores, but at a 0.04 significance level.  

Next time, I will continue going through the survey. The presence of an arts supervisor does not necessarily equate to a well-resourced and efficacious arts program, so I hope to find some interesting questions.

## Part Two

### Arts Supervisors

New York City public schools were asked whether their arts supervisor was employed full- or part-time. If their supervisor was full-time, schools clarified whether they were solely working on arts programs or had other responsibilities.  
In small schools, or under-resourced ones, faculty may be expected to wear many hats. In the simplest cases, physical education teachers lead gym and health classes. More extreme examples can have teachers with certification in, for example, English teaching classes in math or science. I do not assert that an arts supervisor *must* be employed full-time to run an effective program, but I am curious as to what features predict their employment status.  

```{r q3 bar}
superv_status <- factor(c('Full-time, solely for arts', 'Full-time, with other duties', 'Part-time', 'None'),
                          levels=c('Full-time, solely for arts', 'Full-time, with other duties', 'Part-time', 'None'))

df %>% dplyr::select(q3) %>%
  colSums() %>% as_data_frame() %>%
  cbind(superv_status) %>% 
  ggplot(aes(x=reorder(superv_status, -value),
             y=value)) +
  geom_bar(stat = 'identity') +
  ggtitle('Arts Supervisor Employment Status') +
  xlab('Employment Status') + ylab('Frequency') +
  theme_eric() +
  theme(title=element_text(size=16),
        axis.text=element_text(size=12))
```

There are many full-time supervisors with duties other than the arts. I would be curious to discover the share of their responsibilities that are considered "other". It is possible that some administrators consider teaching an arts class or doing clerical work to be "other". Relative to the number of supervisors working full-time, there are few part-timers.  

```{r missing q3, results = 'hide'}
df$Q3 <- with(df, ifelse(Q3_1 == 1, '1',
                ifelse(Q3_2 == 1, '2',
                       ifelse(Q3_3 == 1, '3',
                              ifelse(Q3_4 == 1, '4', '0')))))
df$Q3 <- df$Q3 %>% factor(levels=seq(0,4))
df %>% filter(Q3 == '0') %>% count()
#Two schools did not respond to Q3
```

Only two schools did not respond to this question about their arts supervisor's status. In the previous [part](https://ecboxer.github.io/eda/art_education/arts_survey_1.html), I looked at the question of whether a school had a designated arts liaison. 72 schools responded that they did not, while 296 schools do not have any arts supervisor. I wonder whether the presence of an arts supervisor has more or less influence on student academic performance, relative to arts liaisons.  

To begin exploring academic performance, I will use the percentage of students to perform at or above standards for English Language Arts (ELA) and math.  

```{r math and ela scores, fig.width=8, fig.height=8}
df %>% dplyr::select(perc_34_all_2018, Q3) %>%
  filter(!is.na(perc_34_all_2018_ela)) %>% 
  filter(Q3 != 0) %>% 
  mutate(Q3 = factor(ifelse(Q3 == 1, 'Full-time, solely for arts',
                            ifelse(Q3 == 2, 'Full-time, with other duties',
                                   ifelse(Q3 == 3, 'Part-time', 'None'))))) %>% 
  ggplot(aes(x=perc_34_all_2018_ela, y=perc_34_all_2018_math)) +
  geom_point(alpha = .8) + facet_wrap(~Q3,
                            labeller = label_value) +
  ggtitle('Academic Performance, by Supervisor Status') +
  xlab('Students Passing, ELA (%)') +
  ylab('Students Passing, Math (%)') + theme_eric() +
  theme(text = element_text(size=16),
        axis.text.x = element_text(size=8))
```

I came into this analysis with some suspicion that arts programs might be more beneficial for ELA performance than for math, if they were to have any effect. In the plot above there is a positive relationship between ELA and math scores, regardless of art supervisor status.  

```{r supervisor status stats, results = 'hide'}
for (i in seq(4)) {
  lm.fit <- df %>% 
    dplyr::select(perc_34_all_2018, Q3) %>% 
    filter(Q3 == i) %>% 
    lm(perc_34_all_2018_ela~perc_34_all_2018_math, data=.)
  print(i)
  print(lm.fit %>% summary())
  print(lm.fit %>% confint())
}
```

```{r supervisor performance stats null}
lm.fit.null <- df %>%
  dplyr::select(perc_34_all_2018) %>% 
  rename(Math_score = perc_34_all_2018_math,
         ELA_score = perc_34_all_2018_ela) %>% 
  lm(Math_score~., data=.)
lm.fit.null.summ <- lm.fit.null %>% summary()
lm.fit.null.summ
```
#### Output 1

On inspection the relation between the two scores seems identical between supervisor statuses. In fact, fitting a linear regression to each yields coefficients close to the uncontrolled coefficient for math scores on ELA scores, 1.06415 (Output 1). $Math\_score = \beta_0 + \beta_1 * ELA\_score$  

```{r supervisor performance stats control}
lm.fit <- df %>%
  dplyr::select(q3, perc_34_all_2018) %>% 
  rename(Math_score = perc_34_all_2018_math,
         ELA_score = perc_34_all_2018_ela) %>% 
  lm(Math_score~., data=.)
lm.fit.summ <- lm.fit %>% summary()
lm.fit.summ
```
#### Output 2

We can control for supervisor status with dummy variables by altering the regression like so, $Math\_score = \beta_0 + \beta_1 * ELA\_score + \beta_2 * Q3\_1 + \beta_3 * Q3\_2 + \beta_4 * Q3\_3 + \beta_5 * Q3\_4$, where $Q3\_i$ corresponds to the $i^{th}$ member of the list `c('Full-time, solely for arts', 'Full-time, with other duties', 'Part-time', 'None')` (Output 2).  

```{r supervisor performance stats control confint}
lm.fit %>% confint()
```
#### Output 3

This model specification does not result in a compellingly significant coefficient for the effect of a particular supervisor status. Any status is estimated to have a positive coefficient, but a 95% confidence interval (Output 3) does not exclude the possibility that any of status coefficients could be zero.  

```{r supervisor performance diff, echo=TRUE}
delta.beta1 <- coefficients(lm.fit.null.summ)[2,1] - coefficients(lm.fit.summ)[6,1]
delta.beta1
se.delta.beta1 <- sqrt(coefficients(lm.fit.null.summ)[2,2]^2 + coefficients(lm.fit.summ)[6,2]^2)
se.delta.beta1
```
#### Output 4

On inspection, the regression coefficients for `ELA_score` are close between model specifications A (no controls) and B (controlling for supervisor status). The difference in estimated coefficients $\beta_1$ is -0.0003 (Output 4). To find the variability of the difference in regression coefficients, we use the formula $Var(A-B) = Var(A) + Var(B) - 2*Cov(A,B)$. Assuming covariance between the two estimates is zero, we arrive at 0.0201 as the standard error of the difference.  
Now I can assert that there is no difference in the relationsip between ELA and math scores from supervisor statuses.  

```{r mosaic, fig.width=15, fig.height=10}
library(ggmosaic)
df %>% 
  dplyr::select(Q2_1, Q3) %>% 
  mutate(Q2_1 = ifelse(Q2_1 == 1, 'No', 'Yes'),
         Q3 = factor(ifelse(Q3 == 1, 'Full-time, solely for arts',
                            ifelse(Q3 == 2, 'Full-time, with other duties',
                                   ifelse(Q3 == 3, 'Part-time', 'None'))))) %>% 
  mutate(Q3 = as_factor(Q3, levels = c('Full-time, solely for arts',
                    'Full-time, with other duties',
                    'Part-time',
                    'None'))) %>% 
  ggplot() + 
  geom_mosaic(aes(x=product(Q3, Q2_1), fill=Q3), na.rm=T) +
  scale_fill_manual(values=c5) +
  ggtitle('Does Having an Arts Liaison Affect Supervisor Status?') +
  xlab('School arts liaison?') +
  ylab('Arts Supervisor Status') + theme_eric() +
  theme(text = element_text(size=20),
        axis.text.x = element_text(size=12))
```

This mosaic plot illustrates that the proportion of schools without an arts program supervisor is greater for schools without an arts liaison that for those with. This lends support to the idea that those schools are lacking the resources to fully staff their arts programs, as they have not filled two key positions. It is of course possible that arts liaisons and supervisors are not necessary to effective programs, and schools without either are running just fine. I would like to assess the quality of the arts programs themselves as a function their liaison and supervisor statuses, perhaps through some sort of measure of funding or arts resources.  

***

The next questions concern certifications that arts supervisors may have, either in an arts discipline or in administration.  

```{r supervisor cert both, results = 'hide'}
df %>% filter(Q4_1 == 1 & Q5_1 == 1) %>% count()
df %>% filter(Q4_1 == 1) %>% count()
df %>% filter(Q5_1 == 1) %>% count()
```

```{r supervisor cert}
df$supervisor_cert <- with(df, ifelse(Q4_1 == 1 & Q5_1 == 1, 'Both',
                ifelse(Q4_1 == 1 & Q5_1 == 0, 'Arts',
                       ifelse(Q4_1 == 0 & Q5_1 == 1, 'Administration', 'None'))))
df %>% dplyr::select(Q0_DBN, supervisor_cert) %>% 
  group_by(supervisor_cert) %>% 
  count() %>% 
  ggplot(aes(x=supervisor_cert, y=n)) +
  geom_bar(stat='identity') +
  ggtitle('Does the Arts Supervisor Have Any Certifications?') +
  xlab('Supervisor Certification') + ylab('Frequency') +
  theme(text = element_text(size=16),
        axis.text.x = element_text(size=8)) +
  theme_eric()
```

Few supervisors are certified in the arts, the majority are administrators. Could this have an impact on the efficacy of an arts program?  

```{r supervisor cert stats, results='hide'}
df <- df %>%
  mutate(supervisor_cert_both = ifelse(Q4_1 == 1 & Q5_1 == 1, 1, 0))
q_certs <- c('Q4_1', 'Q5_1', 'supervisor_cert_both')
df %>%
  dplyr::select(q_certs, perc_34_all_2018_ela) %>% 
  lm(perc_34_all_2018_ela~., data=.) %>% 
  summary()
df %>%
  dplyr::select(q_certs, perc_34_all_2018_math) %>% 
  lm(perc_34_all_2018_math~., data=.) %>% 
  summary()
```

Linear regressions do not yield a statistically significant result for the effect of either or both supervisor certification on student academic performance. The model specifications I tried out were of the form $score = \beta_0 + \beta_1 * arts\_cert + \beta_2 * admin\_cert + \beta_3 * both\_cert$.  

```{r supervisor cert stats ctrl}
df <- df %>%
  mutate(supervisor_cert_both = ifelse(Q4_1 == 1 & Q5_1 == 1, 1, 0))
q_certs <- c('Q4_1', 'Q5_1', 'supervisor_cert_both')
lm.ela <- df %>%
  dplyr::select(q_certs, total_enrollment_2017, perc_black_2017, perc_pov_2017, perc_34_all_2018_ela) %>% 
  rename(arts_cert = Q4_1,
         admin_cert = Q5_1,
         both_cert = supervisor_cert_both) %>% 
  lm(perc_34_all_2018_ela~., data=.)
lm.ela %>% summary()
lm.ela %>% confint()
lm.math <- df %>%
  dplyr::select(q_certs, total_enrollment_2017, perc_black_2017, perc_pov_2017, perc_34_all_2018_math) %>% 
  rename(arts_cert = Q4_1,
         admin_cert = Q5_1,
         both_cert = supervisor_cert_both) %>% 
  lm(perc_34_all_2018_math~., data=.)
lm.math %>% summary()
lm.math %>% confint()
```
#### Output 5

After controlling for school size and percentage of black and impoverished students, there is no statistically significant effect for certifications on academic performance. A 95% confidence interval of the coefficient for supervisor certification in administration includes zero for ELA and math scores, so we cannot claim that there is a statistically significant nonzero effect on academic performance. The confidence interval for arts or both certifications are even wider.  

```{r supervisor cert stats narrow ctrl setup}
perc_4_all_2018 <- df %>% colnames() %>% .[grepl('perc_4_All Grades_2018', .)]
#Rename perc_4
temp <- c('perc_4_all_2018_ela', 'perc_4_all_2018_math')
colnames(df)[colnames(df) %in% perc_4_all_2018] <- temp
perc_4_all_2018 <- temp

df <- df %>%
  mutate(supervisor_cert_both = ifelse(Q4_1 == 1 & Q5_1 == 1, 1, 0))

```

```{r supervisor cert stats narrow ctrl}
q_certs <- c('Q4_1', 'Q5_1', 'supervisor_cert_both')
lm.ela <- df %>%
  dplyr::select(q_certs, total_enrollment_2017, perc_black_2017, perc_pov_2017, perc_4_all_2018_ela) %>% 
  rename(arts_cert = Q4_1,
         admin_cert = Q5_1,
         both_cert = supervisor_cert_both) %>% 
  lm(perc_4_all_2018_ela~., data=.)
lm.ela %>% summary()
lm.ela %>% confint()
lm.math <- df %>%
  dplyr::select(q_certs, total_enrollment_2017, perc_black_2017, perc_pov_2017, perc_4_all_2018_math) %>% 
  rename(arts_cert = Q4_1,
         admin_cert = Q5_1,
         both_cert = supervisor_cert_both) %>% 
  lm(perc_4_all_2018_math~., data=.)
lm.math %>% summary()
lm.math %>% confint()
```
#### Output 6

If we drill down further, looking at only the percentage of students to receive a 4 (the highest grade), then there is a statistically significant coefficient for the effect of both certifications on math scores, with a p-value of 0.048996 (Output 6). In this case, a 95% confidence interval just excludes zero, being [0.025, 11.354].  
Having been able to arrive at this more tenuous result I feel a renewed belief that arts programs do have an effect on academic performance and that some proof is lying in the data somewhere. On the other hand I am suspicious as to how I *manufactured* this result by narrowing my focus until I hacked my way to an accceptable p-value.  

## Data Provenance
The [2017-2018 Arts Survey Data](https://data.cityofnewyork.us/Education/2017-2018-Arts-Survey-Data/475h-cg5t) has data about arts teachers, budgets, partnerships with cultural organizations and parental involvement in NYC public schools.  

In an effort to gain greater context for this data, I have examined it in conjuction with publicly available [ELA and Math state test results](https://infohub.nyced.org/reports-and-policies/citywide-information-and-data/test-results) and [demographic data](https://data.cityofnewyork.us/Education/2013-2018-Demographic-Snapshot-School/s52a-8aq6).  

My goals are to understand the state of arts programs in NYC schools, what variables affect the resources of arts programs, and whether arts programs have an effect on the academic performance of students.  

## Part Three

### Resources Devoted to Arts Education

This is part of an extended look at the NYC School Arts Survey:  
[Part One: Arts Education Liaisons](https://ecboxer.github.io/eda/art_education/arts_survey_1.html)  
[Part Two: Arts Education Supervisors](https://ecboxer.github.io/eda/art_education/arts_survey_2.html)  

The survey had several questions regarding which resources schools are devoting to arts education, whether the administrator thought they were sufficient and which non-Department of Education sources of support were available to them.    

Schools were asked how many rooms they have dedicated to arts education. Rooms were divided into two categories: "rooms designed and used solely for the arts" and "multi-purpose or general education classroooms used for arts education". Five arts disciplines were considered: dance, music, theater, visual arts, and media arts (a category which includes film and photography). Note that the term media arts refers to film programs.  
Number of rooms is certainly not a direct metric for a school's commitment to the arts. I hypothesize that it may prove useful for assessing the resources that are made available for arts education more broadly. Of course, there may be confounding factors, such as school size and borough.  

```{r rooms setup}
q8 <- df %>% colnames() %>% .[grepl('Q8_', .)]
df <- df %>%
  mutate(dance_rooms = Q8_R1_C1 + Q8_R1_C2,
         music_rooms = Q8_R2_C1 + Q8_R2_C2,
         theater_rooms = Q8_R3_C1 + Q8_R3_C2,
         visual_arts_rooms = Q8_R4_C1 + Q8_R4_C2,
         media_arts_rooms = Q8_R5_C1 + Q8_R5_C2)
rooms <- df %>% colnames %>% .[grepl('rooms', .)]
df %>% 
  dplyr::select(ends_with('rooms')) %>% 
  gather(key = discipline,
         value = num) %>%
  ggplot(aes(x=num)) +
  geom_density() +
  facet_wrap(~discipline, labeller=label_value) +
  xlab('Number of rooms') +
  ggtitle('Number of rooms used in arts education') +
  theme_eric()
df %>% 
  dplyr::select(ends_with('rooms')) %>% 
  gather(key = discipline,
         value = num) %>%
  ggplot(aes(x=num)) +
  geom_histogram(bins=30) +
  facet_wrap(~discipline, labeller=label_value) +
  xlab('Number of rooms') + 
  theme_eric()
```

All disciplines show the same trend; many schools have zero to two rooms for a given discipline and a few schools have more than twenty rooms. Having twenty-some rooms might be bordering on unrealistic, but the above plots depict both categories of rooms, those designed solely for the arts and multi-purpose. Will we get more reasonable numbers by examining the room counts separately?  

```{r rooms solely}
df %>%
  dplyr::select(q8) %>%
  dplyr::select(ends_with('C1')) %>% 
  mutate(dance_rooms = Q8_R1_C1,
         music_rooms = Q8_R2_C1,
         theater_rooms = Q8_R3_C1,
         visual_arts_rooms = Q8_R4_C1,
         media_arts_rooms = Q8_R5_C1) %>% 
  dplyr::select(ends_with('rooms')) %>% 
  gather(key = discipline,
         value = num) %>% 
  filter(!is.na(num)) %>% 
  ggplot(aes(x=num)) +
  geom_density() +
  facet_wrap(~discipline) +
  ggtitle('Rooms designed and used solely for the arts') +
  theme_eric()
df %>%
  dplyr::select(q8) %>%
  dplyr::select(ends_with('C2')) %>% 
  mutate(dance_rooms = Q8_R1_C2,
         music_rooms = Q8_R2_C2,
         theater_rooms = Q8_R3_C2,
         visual_arts_rooms = Q8_R4_C2,
         media_arts_rooms = Q8_R5_C2) %>% 
  dplyr::select(ends_with('rooms')) %>% 
  gather(key = discipline,
         value = num) %>% 
  filter(!is.na(num)) %>% 
  ggplot(aes(x=num)) +
  geom_density() +
  facet_wrap(~discipline) +
  ggtitle('Multi-purpose and general education classrooms used for arts education') + 
  theme_eric()
```

Looking at the number of rooms designed solely for the arts, the maximum number of rooms is a more reasonable thirteen. For a school with several hundred students and a dedicated arts program I can picture that. If we look at multi-purpose rooms, we see that this class contains the bulk of the rooms. Not many schools have dozens of multi-purpose rooms for arts disciplines, but again, in the context of a large school, it seems like a possible number for some schools to have.  
I would be curious to discover the overlap for multi-purpose rooms among arts disciplines. In other words, is a school with twenty multi-purpose rooms reporting some of those rooms as in use for multiple arts discipline? I do not see any way to completely correct for that possibility, but it would be interesting to control for school size to try to get to the bottom of it. If this does not work, then we could consider only the number of rooms designed solely for art, but this could penalize small schools unduly.  

```{r rooms stats}
#ELA
df %>% dplyr::select(rooms, total_enrollment_2017, perc_34_all_2018_ela) %>% 
  lm(perc_34_all_2018_ela~., data=.) %>% 
  summary()
#Math
df %>% dplyr::select(rooms, total_enrollment_2017, perc_34_all_2018_math) %>%
  lm(perc_34_all_2018_math~., data=.) %>% 
  summary()
```
#### Output 7

Conditioning on the effect of school size, through total enrollment, we can see no statistically significant effect for the total number of rooms for arts education on student academic performance (Ouptput 7).  

```{r rooms stats ctrl}
rooms_ded <- df %>%
  dplyr::select(q8) %>%
  dplyr::select(ends_with('C1')) %>% colnames()
rooms_mul <- df %>%
  dplyr::select(q8) %>%
  dplyr::select(ends_with('C2')) %>% colnames()
#ELA dedicated
df %>% dplyr::select(rooms_ded, total_enrollment_2017, perc_34_all_2018_ela) %>% 
  lm(perc_34_all_2018_ela~., data=.) %>% 
  summary()
#Math dedicated
df %>% dplyr::select(rooms_ded, total_enrollment_2017, perc_34_all_2018_math) %>%
  lm(perc_34_all_2018_math~., data=.) %>% 
  summary()
```

```{r rooms stats ctrl multi, results='hide'}
#ELA multi
df %>% dplyr::select(rooms_mul, total_enrollment_2017, perc_34_all_2018_ela) %>% 
  lm(perc_34_all_2018_ela~., data=.) %>% 
  summary()
#Math multi
df %>% dplyr::select(rooms_mul, total_enrollment_2017, perc_34_all_2018_math) %>%
  lm(perc_34_all_2018_math~., data=.) %>% 
  summary()
```
#### Output 8

Controlling for school size, through total student enrollment, we can see a statistically significant (p-value less than 0.001) positive coefficient for the effect of additional rooms designed and used solely for music, on ELA state test scores (Output 8). If we consider math scores, rooms solely dedicated to music still have a positive effect, but at a 0.0044 p-value. No other arts disciplines have a statistically significant effect on ELA scores, but dance and media arts rooms have statistically significant (p-value less than 0.05) negative effects on math scores.  
When we consider multi-purpose rooms, no arts discipline has a statistically significant effect on academic performance.  
I am curious about the reason behind why music rooms appear to be associated with higher test scores, and why dance and media arts are associated with lower scores. To investigate we can try to control for different features and divide the performance metric by grade.  

```{r rooms grades}
ela_2018 <- q_ela %>% .[grepl('perc_34_[3-8]_2018',.)]
math_2018 <- q_math %>% .[grepl('perc_34_[3-8]_2018',.)]
for (i in ela_2018) {
  temp <- df %>%
    dplyr::select(i, rooms_ded, total_enrollment_2017) %>% 
    .[complete.cases(.),]
  f.ela.1 <- paste(as.character(i), 'total_enrollment_2017', sep='~')
  f.ela.2 <-  paste(rooms_ded, collapse='+')
  f.ela <- as.formula(paste(f.ela.1, f.ela.2, sep='+'))
  temp <- temp %>% lm(f.ela, data=.)
  if (i %in% c('perc_34_5_2018_ela', 'perc_34_6_2018_ela')){
    print(i)
    print(temp %>% summary())
    # print(temp %>% confint.default())
  }
}
for (i in math_2018) {
  temp <- df %>%
    dplyr::select(i, rooms_ded, total_enrollment_2017) %>% 
    .[complete.cases(.),]
  f.math.1 <- paste(as.character(i), 'total_enrollment_2017', sep='~')
  f.math.2 <-  paste(rooms_ded, collapse='+')
  f.math <- as.formula(paste(f.math.1, f.math.2, sep='+'))
  temp <- temp %>% lm(f.math, data=.)
  if (i %in% c('perc_34_5_2018_math', 'perc_34_6_2018_math')){
    print(i)
    print(temp %>% summary())
    # print(temp %>% confint.default())
  }
}
```
#### Output 9

If we break down academic performance by grade, then the results are not as straigtforward (Output 9). For sixth-, seventh- and eighth-graders' ELA performance, media arts rooms have a more statistically significant negative coefficient than the positive coefficient for music rooms. All grades show a positive coefficient for music rooms, with a p-value no more than 0.01. There is a large jump in media arts between fifth- and sixth-grades, which is the demarcation between elementary and middle schools. A jump of this nature could have an underlying reason, beyond increased susceptibility to media arts programs at the expense of academic performance beginning in middle school. Perhaps not many elementary schools have media arts programs at all, or they are more commonly found in schools that are otherwise performing at an atypical level (higher or lower). Both of these can be checked.  
Math scores show a similar trend to ELA scores, with most grades showing a statistically significant positive coefficient for music rooms. Among middle schools, media arts rooms have a statistically significant negative coefficient. The key difference with ELA scores is that there is not a statistically significant positive coefficient for music rooms on eighth-grade math scores.  

```{r media arts elem}
q_elem <- q_demo %>% .[grepl('grd_[1-5]_2017', .)]
q_mid <- q_demo %>% .[grepl('grd_[6-8]_2017', .)]
disc_5.1 <- c('Dance', 'Music', 'Theater', 'Visual Arts', 'Media Arts')
for (i in 1:5){
  temp <- df %>%
    dplyr::select(q_elem[i], rooms_ded) %>% 
    filter((!!sym(q_elem[i])) > 0) %>% 
    dplyr::select(-(!!sym(q_elem[i]))) %>% 
    colSums(na.rm = T) %>%
    as_data_frame() %>% 
    ggplot(aes(x=disc_5.1, y=value)) +
    geom_bar(stat='identity') +
    ggtitle(q_elem[i]) + theme_eric()
  if (i == 5) {
    print(temp)
  }
}
for (i in 1:3){
  temp <- df %>%
    dplyr::select(q_mid[i], rooms_ded) %>% 
    filter((!!sym(q_mid[i])) > 0) %>% 
    dplyr::select(-(!!sym(q_mid[i]))) %>% 
    colSums(na.rm = T) %>%
    as_data_frame() %>% 
    ggplot(aes(x=disc_5.1, y=value)) +
    geom_bar(stat='identity') +
    ggtitle(q_mid[i]) + theme_eric()
  if (i == 1) {
    print(temp)
  }
}
for (i in q_elem){
  temp <- df %>%
    dplyr::select(i, rooms_ded) %>% 
    filter((!!sym(i)) > 0) %>% 
    dplyr::select(-(!!sym(i))) %>% 
    mutate(dance_rooms = Q8_R1_C1,
           music_rooms = Q8_R2_C1,
           theater_rooms = Q8_R3_C1,
           visual_arts_rooms = Q8_R4_C1,
           media_arts_rooms = Q8_R5_C1) %>% 
    dplyr::select(ends_with('rooms')) %>%
    gather(key = discipline,
           value = num) %>% 
    ggplot(aes(x=num)) +
    geom_density() +
    facet_wrap(~discipline) +
    ggtitle(i) + theme_eric()
  if (i == 'grd_5_2017') {
    print(temp)
  }
}
for (i in q_mid){
  temp <- df %>%
    dplyr::select(i, rooms_ded) %>% 
    filter((!!sym(i)) > 0) %>% 
    dplyr::select(-(!!sym(i))) %>% 
    mutate(dance_rooms = Q8_R1_C1,
           music_rooms = Q8_R2_C1,
           theater_rooms = Q8_R3_C1,
           visual_arts_rooms = Q8_R4_C1,
           media_arts_rooms = Q8_R5_C1) %>% 
    dplyr::select(ends_with('rooms')) %>%
    gather(key = discipline,
           value = num) %>% 
    ggplot(aes(x=num)) +
    geom_density() +
    facet_wrap(~discipline) +
    ggtitle(i) + theme_eric()
  if (i == 'grd_6_2017') {
    print(temp)
  }
}
```

I do not see a significant difference in the distribution of art rooms between elementary and middle schools. Music and visual arts rooms are the most common. Let's look at the performance of schools with media arts programs.  
We can match schools on having media arts rooms while controlling for number of students, number of students in each grade, and perhaps other demographic and academic features. Then we can examine the effect of media arts rooms on academic performance.  

```{r rooms media match}
library(MatchIt)
#Feature for having rooms dedicated to media arts
df <- df %>% filter(!is.na(Q8_R5_C1)) %>% 
  mutate(rm_ded_media = as.integer(pmin(1, Q8_R5_C1, na.rm=T)))
f.1 <- paste(paste(q_elem, collapse='+'), paste(q_mid, collapse='+'), sep='+')
f <- as.formula(paste('rm_ded_media~perc_34_all_2018_ela+total_enrollment_2017', f.1, sep='+'))
temp <- df %>%
  dplyr::select(rm_ded_media, perc_34_all_2018_ela, total_enrollment_2017, q_elem, q_mid) %>% 
  .[complete.cases(.),]
m.out1 <- matchit(f, data=temp, method='nearest', distance='logit')
summary(m.out1)
plot(m.out1)
```
#### Output 10

Propensity score matching improves balance for most features (Output 10).  

```{r rooms ps match}
m.data1 <- match.data(m.out1, distance='pscore')
# hist(m.data1$pscore, breaks=30)
# summary(m.data1$pscore)

with(m.data1, t.test(perc_34_all_2018_ela ~ rm_ded_media))

lm.treat1 <- lm(perc_34_all_2018_ela~rm_ded_media, data=m.data1)
summary(lm.treat1)

lm.treat2 <- m.data1 %>%
  dplyr::select(-weights) %>%
  lm(perc_34_all_2018_ela~., .)
summary(lm.treat2)
```
#### Output 11
Matching suggests that rooms dedicated to media arts are associated with schools with higher ELA scores (Output 11). The result that led to this investigation was that rooms dedicated to media arts are associated with lower state test scores among middle-schoolers. In light of this analysis I cannot draw any firm conclusions, but would be interested to find some instrumental variable to use in lieu of an experiment.  

## Part Four

### Technology Tools

We can also consider the technology tools available to students.
This includes the various cameras, computers, software, and other tools that can be useful for an arts education.
The dataset does not include information on musical instruments, props or other non-tech equipment.
It would be interesting to include that information in a future analysis, since it is certainly the case that those resources are integral to music and theater programs.  

```{r tools setup}
q9 <- df %>% colnames() %>% .[grepl('Q9_', .)]
tools <- c('Animation Software',
           'Color Printers',
           'Darkrooms and Equipment',
           'Digital Drawing Tablets',
           'Digital Still Cameras',
           'Digital Video Cameras',
           'Digital Video Editing Software',
           'DVD Player/Recorder',
           'Interactive Distance Exchange Labs',
           'iPad/iPad mini/iPod',
           'Laptop',
           'Lighting Equipment',
           'MIDI Keyboards',
           'Music Editing Software',
           'Photo Editing Software',
           'Scanners',
           'Smartboard',
           'Sound Equipment',
           'Still 35mm Film Cameras',
           'Tablet (other than an iPad)',
           'TV Studio',
           'Video Projector')
colnames(df)[colnames(df) %in% q9] <- tools
df %>% dplyr::select(tools) %>% colMeans() %>% 
  as_data_frame() %>% 
  ggplot(aes(x=reorder(tools, value), y=value)) +
  geom_bar(stat='identity') +
  coord_flip() +
  xlab('') + ylab('Share of schools') +
  theme(text = element_text(size=16),
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12))
```

Smartboards and laptops are found most frequently.
During my time in school, I never took an art class that used smartboards or laptops (although I can imagine uses for both).
I would hypothesize that these tools have been reported by respondents, as items that are found in the school but not specifically in use for arts education.  
As one would expect, the least frequent tools are suites of equipment: interactive distance exchange labs, darkrooms, and TV studios.  
Moving up the list, we find expensive single pieces of equipment such as film cameras, keyboards and lighting.
Contrary to my expectations, software packages - music and video editing and animation - are not among the most commonly found items. Photo editing software is the most frequent, found in 28% of schools, and music editing software is the least frequent, found in 20%.
80% of schools have laptops, so for only one-quarter of these institutions to have access to music editing software seems like a missed opportunity.
Enterprise software can be expensive but I can imagine that Adobe or Microsoft could garner some goodwill by donating licenses to schools for their tools.
Otherwise, there are free substitutes for the market-leading tools, so this gap in tooling could indicate a lack of technological sophistication on the part of teachers and administrators.  
If there is no benefit to having any of these tools, then efforts to increase their availability would be foolish. We can look at the relationship between these resources and academic performance.  

```{r tools stats, results='hide'}
df %>%
  dplyr::select(tools, perc_34_4_2018_ela) %>% 
  lm(perc_34_4_2018_ela~., data=.) %>% 
  summary()
df %>%
  dplyr::select(tools, perc_34_4_2018_math) %>% 
  lm(perc_34_4_2018_math~., data=.) %>% 
  summary()
```

Animation software has a statistically significant positive coefficient for English and math, p-values 0.00447 and 0.02851, respectively. 
Digital drawing tablets have a significant negative coefficient for English and math, p-values 0.00872 and 0.00653.
These are relatively eccentric items, animation software is found in 23% of schools and digital drawing tablets in 12%.
For these to have the most significant coefficients indicates that we lack data or that the relationships are being confounded somehow.
One route forward would be to seek out similar information from other cities, but we can also look at whether these effects remain if we control for wealth?
Although these are not the most expensive tools, I have a hypothesis that the presence of these tools is statistically related to wealth.
This relationship could be direct or through a common causal variable.  

```{r tools stats ctrl wealth summary, results='hide'}
df %>%
  dplyr::select(tools, perc_pov_2017,
                perc_34_4_2018_ela) %>% 
  lm(perc_34_4_2018_ela~., data=.) %>% 
  summary()
df %>%
  dplyr::select(tools, perc_pov_2017,
                perc_34_4_2018_math) %>% 
  lm(perc_34_4_2018_math~., data=.) %>% 
  summary()
```

```{r tools stats ctrl wealth confint}
df %>%
  dplyr::select(tools, perc_pov_2017,
                perc_34_4_2018_ela) %>% 
  lm(perc_34_4_2018_ela~., data=.) %>% 
  confint()
df %>%
  dplyr::select(tools, perc_pov_2017,
                perc_34_4_2018_math) %>% 
  lm(perc_34_4_2018_math~., data=.) %>% 
  confint()
```

After controlling for wealth, animation software and digital drawing tablets lose their statistical significance.
Instead, scanners have a significant positive coefficient for English and math, p-values fo 0.00328 and 0.00317.
DVD players have a significant positive coefficient for math, p-value 0.00647.
The inclusion of a single variable, the percentage of poverty in the student population, has totally removed the significance we initially found for the presence of animation software and digital drawing tablets, which are on the niche side of the technology tool spectrum.
Now we get the idea that more rudimentary and widely applicable tools - scanners are found in 37% of schools and DVD players in 41% - are correlated with academic performance.
That these tools are not exclusively useful in the context of an arts education, unlike MIDI Keyboards, brings up the possibility that the mechanism for these positive coefficients is not through arts education.
Instead, perhaps students from these schools are able to scan their history assignments or watch science documentaries on DVD instead of on VHS and their grades benefit.  

Which tools are most correlated with demographics of the student population, in particular student wealth?

```{r tools by wealth}
q_demo_2017 <- q_demo %>% .[grepl('2017', .)]
q_demo_2017_regr <- c(q_demo_2017[c(3,9)],
                      q_demo_2017 %>% .[grepl('perc', .)])
q_demo_2017_temp <- q_demo_2017_regr[-2]
for (i in tools) {
  df_temp <- df %>% 
    dplyr::select(i, q_demo_2017_temp)
  formula_temp <- paste(q_demo_2017_temp,
                        collapse='+')
  target_temp <- paste('`', i, '`', sep='')
  formula_temp <- paste(target_temp, formula_temp,
                        sep='~')
  fit <- glm(formula_temp, data=df_temp,
             family='binomial')
  if (i %in% c('iPad/iPad mini/iPod',
               'Lighting Equipment')) {
    print(i); print(fit %>% summary())
    }
}
```

iPads and lighting equipment have statistically significant positive coefficients for the percentage of disabled students, p-values 0.00306 and 0.00191.
We can post hoc justify the relation with iPads as an effort to make content and creativity more accessible to students that might have had difficulties working with other media.
That there is a similar coefficient for lighting equipment does not initially make sense to me.
Since we are controlling for school size and wealth I would not think that we are picking up confounding from that source, but perhaps there is still some confounding.
The percentage of students in poverty is most significantly correlated with MIDI keyboards, an expensive piece of equipment.
We can take it as a good sign that no tools are particularly correlated with the wealth of a school's student population. 
Instead, the most predictive demographic feature for the presence of any of these tools is the size of the student body. For most tools - the exception being interactive distance exchange labs - this is a positive coefficient, and statistically significant at a p-value of 0.001.  

## Part Five

### Borough

We have found that controlling for demographic information, in the form of wealth and racial make-up, can greatly effect our analyses.
This leads to the question of how finely-grained should the demographic features which we consider be.
Diversity is widely variable across the city.
According to the [2000 US Census](https://www1.nyc.gov/site/planning/data-maps/nyc-population/census-2000.page), 59.2% of West Queens residents were foreign-born while only 11.9% of residents of the South Shore of Staten Island were foreign-born.
There is similar diversity in the percentage of residents living in poverty, 38.2% in East Harlem and just 6.6% in the Upper East Side.  
Let us look at the possibility that there is a correlation between the borough of a school and their students' academic performance.  

```{r boroughs setup, results='hide'}
#Extract boroughs
df$boro <- df$Q0_DBN %>% str_extract('\\D')
df <- df %>% mutate(
  K = if_else(boro == 'K', 1, 0),
  X = if_else(boro == 'X', 1, 0),
  M = if_else(boro == 'M', 1, 0),
  Q = if_else(boro == 'Q', 1, 0),
  R = if_else(boro == 'R', 1, 0)
  )
```

```{r boroughs viz}
boro_levels <- df %>% group_by(boro) %>%
  count() %>% arrange(desc(n)) %>%
  dplyr::select(boro) %>% pull()
df %>% 
  mutate(boro = factor(boro,
                       levels=boro_levels)) %>% 
  ggplot() +
  geom_bar(aes(boro)) +
  scale_x_discrete(labels=c('K'='Brooklyn',
                            'X'='Bronx',
                            'M'='Manhattan',
                            'Q'='Queens',
                            'R'='Staten Island')) +
  xlab('') + ylab('Frequency') +
  ggtitle('Number of schools by borough') +
  theme_eric()
```

```{r boroughs performance}
df %>%
  dplyr::select(perc_34_4_2018_ela,
                K, X, M, Q, R) %>% 
  lm(perc_34_4_2018_ela~., data=.) %>% 
  summary()
df %>%
  dplyr::select(perc_34_4_2018_math,
                K, X, M, Q, R) %>% 
  lm(perc_34_4_2018_math~., data=.) %>% 
  summary()
```

Belonging to the Bronx has a significant negative coefficient for English and math scores.
Brooklyn has a less significant negative coefficient, but only for English scores and less negative than that of the Bronx.  
A 95% confidence interval on the coefficient for the Bronx on English scores is [-29.8,-14.9] and for Brooklyn [-15.2,-1.0].
Manhattan and Queens did not have statistically significant coefficients, and we do not have enough Staten Island schools to get a result for them (with only 63 of our 1193 schools).  

```{r borough confint}
print('ELA')
df %>%
  dplyr::select(perc_34_4_2018_ela,
                K, X, M, Q, R) %>% 
  lm(perc_34_4_2018_ela~., data=.) %>% 
  confint()
print('Math')
df %>%
  dplyr::select(perc_34_4_2018_math,
         K, X, M, Q, R) %>% 
  lm(perc_34_4_2018_math~., data=.) %>% 
  confint()
```

Consider, for a moment, the tremendous diversity within each borough.
For example, the difference in poverty levels within Manhattan we pointed to earlier in the comparison of East Harlem and the Upper East Side.
Perhaps controlling for demographic information on a school level will alter the results of our regression analyses.  

```{r boroughs performance ctrl}
print('ELA')
df %>%
  dplyr::select(perc_34_4_2018_ela, perc_black_2017, perc_pov_2017, K, X, M, Q, R) %>% 
  lm(perc_34_4_2018_ela~., data=.) %>% 
  summary()
print('Math')
df %>%
  dplyr::select(perc_34_4_2018_math, perc_black_2017, perc_pov_2017, K, X, M, Q, R) %>% 
  lm(perc_34_4_2018_math~., data=.) %>% 
  summary()
```

Controlling for the percentage of black students and of impoverished students removes the statistical significance of the negative coefficient for the Bronx (for both English and math).
Instead, for English scores, belonging to Brooklyn or Queens is associated with a positive coefficient (p-values 0.0322 and 0.0414). The 95% confidence interval for Brooklyn is [0.452,10.166] and for Queens is [0.198,9.886].
For math scores, Brooklyn and Queens are still the only boroughs with statistically significant coefficients, this time at p-values of 0.000301 and 0.0000574.
A 95% confidence interval for the coefficient for Brooklyn on math scores is [4.713,15.783] and for Queens [5.871,16.913].  

```{r boroughs performance confint ctrl}
print('ELA')
df %>%
  dplyr::select(perc_34_4_2018_ela, perc_black_2017, perc_pov_2017, K, X, M, Q, R) %>% 
  lm(perc_34_4_2018_ela~., data=.) %>% 
  confint()
print('Math')
df %>%
  dplyr::select(perc_34_4_2018_math, perc_black_2017, perc_pov_2017, K, X, M, Q, R) %>% 
  lm(perc_34_4_2018_math~., data=.) %>% 
  confint()
```

It is certainly possible that there are confounding variables at play in this analysis.
For example, although we controlled for the wealth of student families through the percentage of students in poverty, this does not explicitly cover differences in school budgets.
There could be benefits to academic performance from having many students with well-educated parents or being located in a safe neighborhood, and these have not been controlled for.  

## Part Six

### Arts Instructional Hours by Cultural Organizations, Fourth Grade

In the fourth-grade, standardized test scores are used to determine which middle schools a student will be able to attend.
Since this dataset does not contain information on exam performance on the specialized high-school exams (used for admission into the elite NYC public high schools), this is the most interesting year we could focus on.
Schools were asked to report the number of instructional hours provided by cultural organizations in dance, music, theater and visual arts.  
Potential oversights in the data include the number of instructional hours available to each student.
For example, if a school of two hundred students is given ten hours of dance instruction, we cannot determine if twenty students attended the instruction over several days, or if ten groups of twenty students attended just one of ten separate events.  
The number of hours provided by cultural organizations is also not equivalent to the total number of hours of arts instruction in the school.
It is possible that poorer schools are receiving most of this type of instruction since they have been identified as deserving targets.
However, it is just as possible that wealthier schools with active administrators are going after cultural organizations to further enrich their students' educations.  

```{r 4th grade hrs setup, results='hide'}
q16 <- df %>% colnames() %>% .[grepl('Q16_', .)]
df <- df %>% rowwise() %>% 
  mutate(
    dance_hr = sum(Q16_C1_R1 + Q16_C2_R1 ,  Q16_C3_R1 ,  Q16_C4_R1 ,  Q16_C5_R1 ,  Q16_C6_R1 ,  Q16_C7_R1 ,  Q16_C8_R1 ,  Q16_C9_R1 ,  Q16_C10_R1 ,  Q16_C11_R1 ,  Q16_C12_R1 ,  Q16_C13_R1 ,  Q16_C14_R1, na.rm = T),
    music_hr = sum(Q16_C1_R2 ,  Q16_C2_R2 ,  Q16_C3_R2 ,  Q16_C4_R2 ,  Q16_C5_R2 ,  Q16_C6_R2 ,  Q16_C7_R2 ,  Q16_C8_R2 ,  Q16_C9_R2 ,  Q16_C10_R2 ,  Q16_C11_R2 ,  Q16_C12_R2 ,  Q16_C13_R2 ,  Q16_C14_R2, na.rm = T),
    thtr_hr = sum(Q16_C1_R3 ,  Q16_C2_R3 ,  Q16_C3_R1 ,  Q16_C4_R1 ,  Q16_C5_R3 ,  Q16_C6_R3 ,  Q16_C7_R3 ,  Q16_C8_R3 ,  Q16_C9_R3 ,  Q16_C10_R3 ,  Q16_C11_R3 ,  Q16_C12_R3 ,  Q16_C13_R3 ,  Q16_C14_R1, na.rm = T),
    visart_hr = sum(Q16_C1_R4 ,  Q16_C2_R4 ,  Q16_C3_R4 ,  Q16_C4_R4 ,  Q16_C5_R4 ,  Q16_C6_R4 ,  Q16_C7_R4 ,  Q16_C8_R4 ,  Q16_C9_R4 ,  Q16_C10_R4 ,  Q16_C11_R4 ,  Q16_C12_R4 ,  Q16_C13_R4 ,  Q16_C14_R4, na.rm = T)
  )
q_4th_hrs <- df %>% colnames() %>% .[grepl('_hr', .)]
```

```{r 4th grade hrs dist viz}
dance_lim <- df %>%
  dplyr::select(dance_hr) %>% pull %>% 
  quantile(., c(0.95))
music_lim <- df %>%
  dplyr::select(music_hr) %>% pull %>% 
  quantile(., c(0.95))
thtr_lim <- df %>%
  dplyr::select(thtr_hr) %>% pull %>% 
  quantile(., c(0.95))
visart_lim <- df %>%
  dplyr::select(visart_hr) %>% pull %>% 
  quantile(., c(0.95))
g1 <- df %>% dplyr::select(q_4th_hrs) %>% 
  ggplot() +
  geom_histogram(aes(dance_hr), bins=40) +
  xlim(0, dance_lim) + ylim(0, 30) +
  xlab('Hours of instruction') +
  ggtitle('Dance')
g2 <- df %>% dplyr::select(q_4th_hrs) %>% 
  ggplot() +
  geom_histogram(aes(music_hr), bins=40) +
  xlim(0, dance_lim) + ylim(0, 30) +
  xlab('Hours of instruction') +
  ggtitle('Music')
g3 <- df %>% dplyr::select(q_4th_hrs) %>% 
  ggplot() +
  geom_histogram(aes(thtr_hr), bins=40) +
  xlim(0, dance_lim) + ylim(0, 30) +
  xlab('Hours of instruction') +
  ggtitle('Theater')
g4 <- df %>% dplyr::select(q_4th_hrs) %>% 
  ggplot() +
  geom_histogram(aes(visart_hr), bins=40) +
  xlim(0, dance_lim) + ylim(0, 30) +
  xlab('Hours of instruction') +
  ggtitle('Visual Arts')
figure <- ggarrange(g1, g2, g3, g4,
                    labels = c('1', '2', '3', '4'),
                    ncol = 2,
                    nrow = 2)
figure
```

Looking at the distribution of instructional hours for fourth-graders, we observe that schools tended to report instructional hours in multiples of ten.
This does not necessarily throw doubt on the accuracy of school records, since schools may have engaged cultural organizations to provide instruction for round-numbered lengths of time.  
We may also observe that the instructional hours in all disciplines drop off after the sixty hour mark.
There are some schools that received over one-hundred hours of arts instruction from outside organizations.
A natural question is whether the schools receiving the most dance instruction are the same as those receiving the most music, theater or visual arts instruction.
In other words, how well-correlated are instructional hours across disciplines?  

```{r 4th grade hrs corr}
library(ComplexHeatmap)
library(circlize)
cor_heatmap <- df %>%
  dplyr::select(q_4th_hrs) %>%
  dplyr::select(`Visual arts`=visart_hr,
                Theater=thtr_hr,
                Music=music_hr,
                Dance=dance_hr) %>% 
  as.matrix() %>%
  cor()
col_fun = colorRamp2(c(0, 1),
                     c('white', 'red'))
Heatmap(cor_heatmap,
        name='mat',
        col=col_fun,
        heatmap_legend_param=list(
          title='Correlation',
          legend_height=unit(8, 'cm')
        ), cell_fun=function(j,i,x,y,width,height,fill) {
          grid.text(sprintf('%.2f',
                            cor_heatmap[i,j]),
                    x, y, gp=gpar(fontsize=30))
        })
```

The correlation of instructional hours across disciplines is high within the group of dance, music and theater.
In other words, schools that receive a high level of instructional hours in dance tend to receive high levels in music and theater.
There is also correlation with visual arts for all of those disciplines, but to a lesser degree than exists within that group.  

```{r 4th grade hrs perf viz, results='hide'}
g1 <- df %>% dplyr::select(q_4th_hrs, perc_34_4_2018) %>% 
  ggplot(aes(x = dance_hr, y = perc_34_4_2018_ela)) +
  geom_point() + xlim(c(0, 600))
g2 <- df %>% dplyr::select(q_4th_hrs, perc_34_4_2018) %>% 
  ggplot(aes(x = music_hr, y = perc_34_4_2018_ela)) +
  geom_point() + xlim(c(0, 600))
g3 <- df %>% dplyr::select(q_4th_hrs, perc_34_4_2018) %>% 
  ggplot(aes(x = thtr_hr, y = perc_34_4_2018_ela)) +
  geom_point() + xlim(c(0, 600))
g4 <- df %>% dplyr::select(q_4th_hrs, perc_34_4_2018) %>% 
  ggplot(aes(x = visart_hr, y = perc_34_4_2018_ela)) +
  geom_point() + xlim(c(0, 600))
figure <- ggarrange(g1, g2, g3, g4,
                    labels = c('1', '2', '3', '4'),
                    ncol = 2,
                    nrow = 2)
# Do not show
# figure
```

Now let us look at the relationship between student demographics and arts instructional hours from cultural organizations.  

```{r 4th grade hrs demo, results='hide'}
q_demo_2017 <- q_demo %>% .[grepl('2017', .)]
q_demo_2017_regr <- c(q_demo_2017[c(3,9)],
                      q_demo_2017 %>% .[grepl('perc', .)])

fit_dance <- lm(dance_hr~.,
          data=dplyr::select(df,
                             q_demo_2017_regr,
                             dance_hr))
step_dance <- stepAIC(fit_dance, direction='both')
fit_music <- lm(music_hr~.,
          data=dplyr::select(df,
                             q_demo_2017_regr,
                             music_hr))
step_music <- stepAIC(fit_music, direction='both')
fit_thtr <- lm(thtr_hr~.,
          data=dplyr::select(df,
                             q_demo_2017_regr,
                             thtr_hr))
step_thtr <- stepAIC(fit_thtr, direction='both')
fit_visart <- lm(visart_hr~.,
          data=dplyr::select(df,
                             q_demo_2017_regr,
                             visart_hr))
step_visart <- stepAIC(fit_visart, direction='both')
```

```{r 4th grade hrs demo results}
print('Dance')
step_dance %>% summary()
print('Music')
step_music %>% summary()
print('Theater')
step_thtr %>% summary()
print('Visual Arts')
step_visart %>% summary()
```

We fit a linear model to the number of instructional hours provided by cultural organizations using demographic features.
For all disciplines, the only statistically significant feature is the number of fourth-graders.
The coefficients for this feature are positive for each discipline and are significant at a p-value of 0.01 for dance and music and 0.05 for theater and visual arts.  
For the visual arts alone, stepwise feature selection results in other features that are significant at a p-value of 0.1. These others are the racial demographic features - the percentage of asian, black, hispanic, and white students in a school.  
That the number of students was the most significant feature, rather than race, gender or wealth, indicates that the distribution of attention from cultural organizations is not biased by wealth.  
Is there any benefit to student academic performance from additional arts instruction?

```{r 4th grade hours perf}
print('ELA')
df %>%
  dplyr::select(q_4th_hrs, perc_34_4_2018_ela) %>% 
  lm(perc_34_4_2018_ela~., data=.) %>% 
  summary()
print('Math')
df %>%
  dplyr::select(q_4th_hrs, perc_34_4_2018_math) %>% 
  lm(perc_34_4_2018_math~., data=.) %>% 
  summary()
```

No discipline of arts instruction has a statistically significant effect on academic performance, in neither English nor math.
Does this finding change if we control for demographics, in particular the number of fourth-graders?  

```{r 4th grade hours perf ctrl}
df %>%
  dplyr::select(q_4th_hrs, perc_34_4_2018_ela, grd_4_2017) %>% 
  lm(perc_34_4_2018_ela~., data=.) %>% 
  summary()
df %>%
  dplyr::select(q_4th_hrs, perc_34_4_2018_math, grd_4_2017) %>% 
  lm(perc_34_4_2018_math~., data=.) %>% 
  summary()
```

Controlling for the number of fourth-graders does not alter our findings.
Upon reflection, this is not particularly surprising. Considering that the link between arts instruction and academic performance is uncertain and this particular type of instruction is not well-defined.  

## Part Seven

### Screened Arts Programs

```{r screened arts init, results='hide'}
n_screen <- df %>%
  dplyr::select(Q20_1) %>%
  sum()
df_middle <- df %>%
  filter(grd_6_2017 > 0 | grd_7_2017 > 0 | grd_8_2017 > 0)
n_middle <- df_middle %>% nrow()
n_screen
n_screen / n_middle
```

Only 24 middle schools have screened arts programs, that is 6% of the middle schools in our dataset.
We can look at whether certain demographic features are associated with the presence of these programs.    

```{r screened arts middle school, results='hide'}
q_demo_2017_mid <- c(q_demo_2017_regr[-2], 
                     'grd_6_2017', 
                     'grd_7_2017', 
                     'grd_8_2017')
fit_middle <- glm(Q20_1~.,
   data=dplyr::select(df_middle,
                      q_demo_2017_mid,
                      Q20_1),
   family='binomial')
step_middle <- stepAIC(fit_middle,
                       direction='both')
```

```{r screened arts middle school results}
fit_middle %>% summary()
step_middle %>% summary()
```

We fit a logistic regression to the presence of a screened arts program, regressing on demographic features and restricting the dataset to middle schools.
When we perform stepwise feature selection on this model, we find that the percentage of female students has a statistically significant positive coefficient with a p-value of 0.00606.
The percentage of asian, black and hispanic students have statistically significant negative coefficients with p-values at the 0.05 level.
The number of sixth-graders has a postive coefficient with a p-value at the 0.05 level, too.  
Interpreting these results, schools with a screened arts program tend to have more female students (not necessarily a causal relationship) and to be larger.
The part about being larger makes sense, since a large school is more likely to have any feature, be it a Latin class or wheelchair ramps.
On the unfortunate side of things, one could say that minority students are not being served by screened arts programs.
Perhaps this could be addressed by improving arts education in primary schools with minority students or helping families to better navigate the application process for schools with screened arts programs.  
We can run a Wald test to determine if the coefficient for minority students as a whole - asian, black and hispanic - is significant.  

```{r screened arts middle school wald}
# Overall effect of perc_asian, _black and _hisp
wald.test(b=coef(step_middle),
          Sigma=vcov(step_middle),
          Terms=4:6)
```

The p-value of 0.0025 allows us to reject the null hypothesis that the percentage of minority students has a coefficient of zero in the relationship with screened arts programs.  
We can also present our coefficients in a more interpretable way, log-odds.  

```{r screened arts middle school log-odds}
exp(confint(step_middle))
exp(coef(step_middle))
```

First, a 95% confidence interval for the log-odds of the features in the relation with screened arts programs.
The log-odds for the percentage of female students has a 95% confidence interval of [1.012,1.088].
An additional percentage point of female students in a school's gender split is associated with an increase in the probability of a screened arts program of between 1% and 9%.
When phrased in this way it seems like a rather tenuous assertion, in the data 50% of schools have a percentage of female students between 46% and 51%.
The gender makeup of a school is likely harder to swing by a whole percentage point than race or wealth metrics.  
The percentage of asian, black, and hispanic students are associated with confidence intervals of [0.929,0.994], [0.950,0.994], and [0.949,0.994] log-odds for the probability of a school having a screened arts program, respectively.  
We cannot extrapolate from these results that a school with 90% white students will definitely have a screened arts program or that a school with 90% black and hispanic students will not.
It does give food for thought with regards to the distribution of these programs.
We can take a look at whether schools with screened arts programs do well in terms of academic performance.
Seventh grade academic performance will be used as a representative for middle-school performance.
This is the grade during which students take standardized tests which determine their high-school choices.  

```{r screened arts perf, results='hide'}
fit_scr_ela <- lm(perc_34_7_2017_ela~.,
   data=dplyr::select(df_middle,
              Q20_1,
              perc_34_7_2017_ela,
              q_demo_2017_mid))
step_scr_ela <- stepAIC(fit_scr_ela,
                        direction='both')
fit_scr_math <- lm(perc_34_7_2017_math~.,
   data=dplyr::select(df_middle,
              Q20_1,
              perc_34_7_2017_math,
              q_demo_2017_mid))
step_scr_math <- stepAIC(fit_scr_math,
                        direction='both')
```

```{r screened arts perf results}
# fit_scr_ela %>% summary()
step_scr_ela %>% summary()
# fit_scr_math %>% summary()
step_scr_math %>% summary()
```

Fitting a linear regression, for either English or math performance, to having a screened arts program (Q20_1) does not yield a statistically significant coefficient.
This holds when we control for school demographic data, too.  

## Part Eight

### Middle School Arts Sequences

Some middle schools offer a three-year sequence of instruction in a single arts discipline.
This could be very beneficial to the arts education of participating students.
The alternatives methods of arts education tend towards a single class meeting most, but not all days, and lacking the direction that a three-year sequence provides.
It could be interesting to look at the relationship between attending a middle-school with an arts sequence and attending an arts high school.
That would require an individual-level approach and is outside the scope of our dataset.  
Since our data is on the school-level we also cannot control for participation in these programs by individual students.
We may know that a school offers sequences in music and dance but we do not know how many students participate in the programs.
While it is doubtful that the presence of such sequences would have a significant effect on an entire school, we can still take a look.  

```{r 3yr sequence setup}
q22 <- df %>% colnames() %>% .[grepl('Q22', .)] %>% .[grepl('_C1', .)]
df_middle %>%
  dplyr::select(q22) %>%
  colSums() %>% 
  as_data_frame() %>% 
  mutate(value=value / nrow(df_middle)) %>% 
  cbind(disc_5) %>% 
  arrange(desc(value)) %>% 
  ggplot(aes(x=reorder(disc_5, -value),
             y=value)) +
  geom_bar(stat='identity') +
  xlab('') + ylab('Share of schools') +
  ggtitle('How many NYC schools offer an arts sequence?') +
  theme(axis.text=element_text(size=12),
        axis.title.y=element_text(size=16),
        title=element_text(size=16)) +
  theme_eric()
```

There are many visual arts and music sequences.
Fewer schools have dance or theater sequences, and very few have one in film.  
We can take a look at whether any demographic features are correlated with arts sequences.  

```{r seq demographics}
df_middle %>%
  dplyr::select(`Dance sequence`=Q22_R1_C1,
                q_demo_2017_mid) %>% 
  glm(`Dance sequence`~., data=.,
      family='binomial') %>% 
  summary()
```

```{r seq demographics hide, results='hide'}
df_middle %>%
  dplyr::select(`Film sequence`=Q22_R2_C1,
                q_demo_2017_mid) %>% 
  glm(`Film sequence`~., data=.,
      family='binomial') %>% 
  summary()
df_middle %>%
  dplyr::select(`Music sequence`=Q22_R3_C1,
                q_demo_2017_mid) %>% 
  glm(`Music sequence`~., data=.,
      family='binomial') %>% 
  summary()
df_middle %>%
  dplyr::select(`Theater sequence`=Q22_R4_C1,
                q_demo_2017_mid) %>% 
  glm(`Theater sequence`~., data=.,
      family='binomial') %>% 
  summary()
df_middle %>%
  dplyr::select(`Visual arts sequence`=Q22_R5_C1,
                q_demo_2017_mid) %>% 
  glm(`Visual arts sequence`~., data=.,
      family='binomial') %>% 
  summary()
```

In the output above, we can see that the only statistically significant coefficient for dance sequences is a negative one for total enrollment, p-value of 0.00776. 
We can postulate that this result is picking up the negative correlation between school size and a school's emphasis on the arts. 
Schools that offer a dance sequence are more likely to be small.
In middle schools with a dance sequence, the average enrollment in 2017 was 463 students, while in schools without the average was 778 students.
No other sequences have a coefficient with as small a p-value.

```{r 3yr sequence perf, results='hide'}
# R1-R5 Dance, Film, Music, Theater, Visual arts
fit_seq_ela <- lm(perc_34_7_2017_ela~.,
   data=dplyr::select(df_middle,
              q22,
              perc_34_7_2017_ela,
              q_demo_2017_mid))
step_seq_ela <- stepAIC(fit_seq_ela,
                        direction='both')
fit_seq_math <- lm(perc_34_7_2017_math~.,
   data=dplyr::select(df_middle,
              q22,
              perc_34_7_2017_math,
              q_demo_2017_mid))
step_seq_math <- stepAIC(fit_seq_math,
                        direction='both')
```

```{r 3yr sequence perf results}
fit_seq_ela %>% summary()
step_seq_ela %>% summary()
fit_seq_math %>% summary()
step_seq_math %>% summary()
```

Visual arts sequences have a statistically significant positive coefficient for math scores, at a p-value of 0.01. This is the only arts discipline to have a statistically significant coefficient, controlling for school demographic features.  

## Part Nine

### Non-DOE Funding

Schools were asked whether they received funding for arts education from sources other than the Department of Education (DOE).
One would hope that schools serving poor, minority students receive at least as much external funding as those with wealthy and white students.  
We can also look at whether there is an association between academic performance and external funding.
The direction of such a relationship would be ambiguous.
It is possible that funding flows to overperforming schools, as their status attracts donors to them.
On the other hand, additional funding could be the cause of increased academic performance.
To tease this relationship apart we would need to run an experiment or identify an instrumental variable.
Perhaps distance to a large cultural organization could serve as an instrumental variable.
We would still need to control for possible confounding variables introduced by location, such as wealth.  

```{r arts funding sources}
q36 <- q_arts %>% .[grepl('Q36', .)] %>% .[grepl('C1', .)]
fund_srcs <- c('Cultural organizations',
               'Education association',
               'Federal, state, or city grants',
               'Local business or corporation',
               'Private foundation',
               'PTA/PA',
               'State, county, local arts councils')
df %>% dplyr::select(q36) %>%
  colSums() %>% 
  as_data_frame() %>% 
  ggplot(aes(x=reorder(fund_srcs,
                       -value),
             y=value)) +
  geom_bar(stat='identity') +
  ggtitle('Frequency of external funding sources') +
  theme_eric() +
  theme(axis.text=element_text(size=14),
        title=element_text(size=16)) +
  coord_flip() +
  xlab('') + ylab('Count')
```

Government grants are the most common source of non-DOE funding, followed by cultural organizations, and PTA (parent teacher associations).
Educational associations and local business are the least common sources of arts funding.  
Notably, this data only captures whether or not funding from these sources occurs, not how large the funding is or whether there is a long-term partnership with these organizations.  

Does poverty predict any of these sources of funding?  

```{r art funding poverty}
for (i in seq(1,7)) {
  temp <- df %>%
    dplyr::select(q36[i], perc_pov_2017)
  temp.glm <- glm(unlist(temp[,1])~perc_pov_2017,
                  data=temp,
                  family='binomial')
  if (i %in% c(6,7)) {
    print(fund_srcs[i])
    print(summary(temp.glm))
  }
}
```

Poverty has a statistically significant negative coefficient for PTA/PA funding at a p-value of less than 0.001 and local arts councils at a p-value of 0.0280.
Will this effect be clarified or disappear when we control for additional features?  

```{r art funding poverty ctrl black}
for (i in seq(1,7)) {
  temp <- df %>%
    dplyr::select(q36[i], perc_pov_2017, perc_black_2017)
  temp.glm <- glm(unlist(temp[,1])~perc_pov_2017+perc_black_2017,
                  data=temp,
                  family='binomial')
  if (i %in% c(3,6)) {
    print(fund_srcs[i])
    print(summary(temp.glm))
  }
}
```

Now we are performing a binomial regression for each source of funding upon the percentage of impoverished and black students.
Government grants have a statistically significant positive coefficient for percentage of students in poverty, p-value 0.0075, and a negative coefficient for percentage of black students, p-value less than 0.001.
PTA funding has a statistically significant negative coefficient for percentage of students in poverty and black students, both at p-values less than 0.001.  
This analysis tells us that funding from government grants tends to flow to schools with more poor students and not to those with more black students.
PTA funding does not tend to flow to poor schools or schools with black students.  
The finding on government grants going to poor schools is hopeful, since these schools are those not receiving funds from their PTAs.
On the other hand, that government grants are not going to schools with black students is a source of concern.
We have not shown that there is a causal relationship, but this correlation could be investigated further.  
Our findings about the recipients of PTA funding being richer and whiter schools should not be surprising in retrospect.
An active PTA can be the difference between whether a school can afford to purchase newly published textbooks or has to teach from the same science books they bought decades ago.
The current funding system will allocate donations from parents to their own children's schools, so those serving wealthier students will be the schools benefitting from PTA funding.  

```{r art funding poverty ctrl other}
for (i in seq(1,7)) {
  temp <- df %>%
    dplyr::select(q36[i], perc_pov_2017,
                  perc_black_2017,
                  total_enrollment_2017,
                  perc_34_all_2018)
  temp.glm <- glm(unlist(temp[,1])~perc_pov_2017+perc_black_2017+total_enrollment_2017+perc_34_all_2018_ela+perc_34_all_2018_math,
                  data=temp,
                  family='binomial')
  if (i %in% c(3,6,7)) {
    print(fund_srcs[i])
    print(summary(temp.glm))
  }
}
```

Now we have tried controlling for poverty, percentage of black students, total enrollment, and academic performance.
Funding from government grants still has a statistically significant negative coefficient for percentage of black students, at a p-value of 0.0276.
The coefficient for students in poverty is no longer significant. 
PTA funding has a statistically significant negative coefficient for poverty at a p-value of less than 0.001.
The coefficient for percentage of black students is no longer significant here, too.
Funding from arts councils has a statistically significant positive coefficient for student population at a p-value of 0.006928.  
That the association between government grants and percentage of black students continues to be negative is unfortunate.
As is the lack of an association with poor student populations, whom we would hope to be the recipients of greater funding here.
For PTA funding, controlling for the additional features has removed significant coefficients for all features but the wealth of the student population.
As we mentioned earlier, this association is a direct by-product of the PTA system and is to be expected. 
Funding from arts councils has a newly significant association with the size of school population.
This is interesting because we can postulate reasons for this association, such as greater resources available to large schools allowing them to apply to these councils for funding or greater visibility for large schools to attract council attention.
These two mechanisms could be addressed by educating small schools about seeking funding from arts councils or persuading councils to give more to small schools.
It is also possible that the reason is structural.
Large schools cover more and larger local arts councils which results in a greater likelihood of receiving funding from at least one arts council.  

## Part Ten

### Parental Involvement

Schools were asked about whether parents participated in their arts programs in one of the following ways: attending events, volunteering, donating supplies or other.
We can hypothesize that those schools which receive PTA funding tend to have the greatest parental involvement.  

```{r parental inv setup}
q39 <- q_arts %>% .[grepl('Q39', .)]
par_inv <- c('Attending school arts events',
             'Volunteering in arts programs',
             'Donating arts materials',
             'Other')
print('Example responses for "Other":')
df %>% dplyr::select(Q39_4, Q0_DBN) %>% 
  group_by(Q39_4) %>% count() %>% 
  filter(Q39_4 != 0) %>% 
  arrange(desc(n)) %>% head()
```

We can see that some respondents chose to fill the "Other" category with "none".
For the most part, schools did fill in legitimate examples of parental involvement.
We can consider the "Other" category as a form of parental involvement, in general.

```{r parental inv mutate}
df$Q39_Other <- df$Q39_4
df <- df %>% 
  mutate(Q39_4 = ifelse(Q39_4 == 0, 0, 1))
#Move 'Other' over to another column
df %>% dplyr::select(q39) %>% colSums() %>% 
  as_data_frame() %>% 
  ggplot(aes(x=reorder(par_inv, -value),
             y=value / df %>% nrow())) +
  geom_bar(stat='identity') +
  xlab('') + ylab('Proportion of schools') +
  ggtitle('How are parents participating in arts education?') +
  theme_eric() +
  theme(axis.text=element_text(size=14),
        axis.title.x=element_text(size=12),
        title=element_text(size=14)) +
  coord_flip() 
```

Parental participation occurs most commonly in the form of attendance at school events.
This is probably the least time-intensive and most emotionally rewarding of the options.

Is there a relationship between poverty and volunteering in arts programs?

```{r parental inv volunteer}
df %>% 
  dplyr::select(Volunteering=Q39_2, perc_pov_2017, total_enrollment_2017, perc_34_all_2018) %>% 
  glm(Volunteering~.,
      data=., family='binomial') %>% 
  summary()
```

There is a statistically significant negative coefficient for the relationship between poverty and parental volunteering in arts programs at a p-value of 0.00479, even after controlling for school size and academic performance.  

Is there a relationship between poverty and donating arts materials?

```{r parental inv donation}
df %>% 
  dplyr::select(Donating=Q39_3, perc_pov_2017, total_enrollment_2017, perc_34_all_2018) %>% 
  glm(Donating~.,
      data=., family='binomial') %>% 
  summary()
```

There is a statisically significant negative coefficient for the relationship between poverty and donating arts materials at a p-value of less than 0.001.  
We can explicitly look at the correlation between a school receiving funding from their PTA and parental involvement in the arts.

```{r parental inv corr, fig.height=8, fig.width=8}
library(lattice)
df %>%
  dplyr::select(q39, Q36_R6_C1) %>% 
  dplyr::select('Attending events'=Q39_1,
                'Volunteering'=Q39_2,
                'Donations'=Q39_3,
                'Other'=Q39_4,
                'PTA Funding'=Q36_R6_C1) %>% 
  cor() %>% 
  levelplot(col.regions=heat.colors(100)[length(heat.colors(100)):1],
            xlab='', ylab='',
            labels=T)
```

Of the different methods by which parents can become involved with arts programs directly, PTA funding is most closely associated with donations.
This makes sense, in particular if we consider that schools reporting parental involvement through donations may have taken these into consideration when reporting PTA funding.
While some administrators may consider these sources of funding to be distinct, it is not clear that all would agree on this point.  
